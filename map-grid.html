<!DOCTYPE html>
<html>

<head>
    <title>瓦片网格查看器</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
        }

        .leaflet-control-custom {
            background: white;
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .leaflet-control-custom input {
            width: 220px;
            padding: 3px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        // 初始化地图，可自由缩放
        var map = L.map('map', { attributionControl: false }).setView([0, 0], 2);
        L.control.attribution({ prefix: false }).addTo(map);

        // 默认底图瓦片地址


        var baseUrl = 'https://tiles.windy.com/tiles/v10.0/darkmap/{z}/{x}/{y}.png'
        var base_layer = L.tileLayer(baseUrl, {
            minZoom: 1,
            maxZoom: 18,
            tms: false,
            attribution: 'Base Tiles'
        }).addTo(map);
        // 自定义瓦片地址

        var tileUrl = 'file:///F:/Desktop/MapTiles/GMRT/{z}/{x}/{y}.png';
        var tilesource_layer = L.tileLayer(tileUrl, {
            minZoom: 1,
            maxZoom: 18,
            tms: false,
            attribution: 'Add Tiles'
        }).addTo(map);

        // 自动检测 URL 索引格式
        var useXYZ = tileUrl.includes("{x}/{y}");

        // 当前选择的层级，null 表示未锁定
        var forcedZoom = null;

        // 自定义网格层
        var gridLayer = L.gridLayer({ attribution: 'Tile Index Grid' });

        gridLayer.createTile = function (coords) {
            var tile = document.createElement('div');
            var size = this.getTileSize();
            tile.style.width = size.x + 'px';
            tile.style.height = size.y + 'px';
            tile.style.fontSize = "12px";
            tile.style.fontWeight = "bold";
            tile.style.color = "black";
            tile.style.border = "1px solid rgba(0,0,0,0.3)";
            tile.style.textAlign = "center";
            tile.style.display = "flex";
            tile.style.alignItems = "center";
            tile.style.justifyContent = "center";

            // 如果强制层级，覆盖 coords.z
            var z = forcedZoom !== null ? forcedZoom : coords.z;
            var x = coords.x;
            var y = coords.y;

            var index = useXYZ ? `${z}/${x}/${y}` : `${z}/${y}/${x}`;

            // 替换 URL
            var url = tileUrl.replace("{z}", z).replace("{x}", x).replace("{y}", y);

            var img = new Image();
            img.src = url;
            img.onload = function () {
                tile.style.background = "rgba(0,255,0,0.3)";
                tile.innerHTML = index;
            };
            img.onerror = function () {
                tile.style.background = "rgba(255,0,0,0.3)";
                tile.innerHTML = index;
            };

            return tile;
        };

        // 切换网格按钮
        var toggleControl = L.control({ position: 'topright' });
        toggleControl.onAdd = function () {
            var div = L.DomUtil.create('div', 'leaflet-control-custom');
            div.innerHTML = "切换网格";
            div.style.cursor = "pointer";
            div.onclick = function () {
                if (map.hasLayer(gridLayer)) {
                    map.removeLayer(gridLayer);
                } else {
                    gridLayer.addTo(map);
                }
            };
            return div;
        };
        toggleControl.addTo(map);



        // URL 输入框
        var urlControl = L.control({ position: 'topright' });
        urlControl.onAdd = function () {
            var div = L.DomUtil.create('div', 'leaflet-control-custom');
            var input = document.createElement('input');
            input.type = "text";
            input.value = tileUrl;
            input.placeholder = "输入瓦片URL模板";
            div.appendChild(input);

            input.addEventListener("change", function () {
                tileUrl = input.value.trim();
                // 自动检测索引格式
                useXYZ = tileUrl.includes("{x}/{y}");
                // 重新加载底图
                if (map.hasLayer(tilesource_layer)) {
                    map.removeLayer(tilesource_layer);
                }
                tilesource_layer = L.tileLayer(tileUrl, {
                    minZoom: 1,
                    maxZoom: 18,
                    tms: false,
                    attribution: 'Add Tiles'
                }).addTo(map);
                // 刷新网格
                if (map.hasLayer(gridLayer)) {
                    gridLayer.redraw();
                }
            });

            return div;
        };
        urlControl.addTo(map);
    </script>
</body>

</html>